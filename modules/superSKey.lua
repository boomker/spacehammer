hs.loadSpoon("ModalMgr")
require("modules.base")
require("modules.ksheet")
require("configs.shortcuts")
require("modules.superSCore")
require("modules.hotkeyHelper")

local skmodal = nil
if spoon.ModalMgr then
    spoon.ModalMgr:new("SuperSKey")
    skmodal = spoon.ModalMgr.modal_list["SuperSKey"]

    skmodal:bind("", "escape", "exit SuperSKeyæ¨¡å¼", function()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "Q", "exit SuperSKeyæ¨¡å¼", function()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "tab", "é”®ä½æç¤º", function()
        spoon.ModalMgr:toggleCheatsheet()
    end)
    skmodal:bind("", "Z", "æ˜¾ç¤ºæ¡Œé¢", function()
        hs.spaces.toggleShowDesktop()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "S", "KSheetçœ‹åº”ç”¨çƒ­é”®", function()
        showAppShortCutsPane()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "W", "æ˜¾ç¤ºçª—å£ç®¡ç†æ‰€æœ‰çƒ­é”®", function()
        showHSHotKeysPane("WindowMOnly")
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "H", "æ‰“å¼€å¿«æ·é”®æ˜¾ç¤ºé¢æ¿", function()
        showHSHotKeysPane("all")
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "G", "å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•ä¸­å¿ƒ", function()
        screenCenter()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "Y", "å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•å·¦ä¸Šè§’", function()
        screenTopLeft()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "U", "å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•å³ä¸Šè§’", function()
        screenTopRight()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "I", "å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•å·¦ä¸‹è§’", function()
        screenBottomLeft()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "O", "å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•å³ä¸‹è§’", function()
        screenBottomRight()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "X", "ç§»é™¤æ¡Œé¢ç©ºé—´", function()
        removeDeskTopSpace()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "A", "æ–°å¢æ¡Œé¢ç©ºé—´", function()
        addDeskTopSpace()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "B", "è“ç‰™å¼€å…³è¿æ¥", function()
        connetBluetoothDevice()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "N", "å¼€å…³å‹¿æ‰°æ¨¡å¼", function()
        hs.eventtap.keyStroke(superKey_items.toggleDND[1], superKey_items.toggleDND[2])
        hs.alert.show("å‹¿æ‰°æ¨¡å¼åˆ‡æ¢æˆåŠŸ", 0.5)
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "D", "æš—å¤œæ¨¡å¼åˆ‡æ¢", function()
        toggleDarkMode()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "F", "å¼€å¯ä¸“æ³¨æ¨¡å¼", function()
        enableFocuseMode()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "C", "caffeineMode", function()
        togglecaffeineMode()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "E", "ejectæ‰€æœ‰DMGç£ç›˜", function()
        ejectAllDMG()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "K", "å¼ºæ€åº”ç”¨", function()
        forceKillCurApp()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "L", "é”å±", function()
        hs.eventtap.keyStroke({ "Cmd", "Ctrl" }, "Q")
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "R", "é‡å¯", function()
        restartMac()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "J", "ğŸ”ˆæ‰¬å£°å™¨é™éŸ³", function()
        toggleMute()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "M", "ğŸ¤éº¦å…‹é£å¼€å…³é™éŸ³", function()
        toggleMicrophoneMute()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "P", "Play/Pause", function()
        require("hs.eventtap").event.newSystemKeyEvent("PLAY", true):post()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind({ "Shift" }, "P", "æ‰“å¼€å®‰å…¨ä¸éšç§", function()
        openSecAndPrivacy()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "T", "æ‰“å¼€æ´»åŠ¨ç›‘è§†å™¨", function()
        hs.application.launchOrFocusByBundleID("com.apple.ActivityMonitor")
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind("", "V", "ç²˜è´´å¯†ç ", function()
        hs.eventtap.keyStrokes(hs.pasteboard.getContents())
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind({ "Shift" }, "U", "ä¸€é”®å‡çº§brew", function()
        oneKeyUpgradeBrews()
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind({ "Shift" }, "I", "æ‰“å¼€Bartenderæœç´¢é¢æ¿", function()
        hs.eventtap.keyStroke(superKey_items.bartenderMenuSearch[1], superKey_items.bartenderMenuSearch[2])
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)
    skmodal:bind({ "Shift" }, "O", "æ‰“å¼€BobOCR", function()
        hs.eventtap.keyStroke(superKey_items.bobOCR[1], superKey_items.bobOCR[2])
        spoon.ModalMgr:deactivate({ "SuperSKey" })
    end)

    spoon.ModalMgr.supervisor:bind(superKey_toggle[1], superKey_toggle[2], "è¿›å…¥SuperSKeyæ¨¡å¼", function()
        spoon.ModalMgr:deactivateAll()
        -- æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ‰€å¤„æ¨¡å¼
        spoon.ModalMgr:activate({ "SuperSKey" }, "#C99999")
    end)
end

--------------- å¼€æœºç™»é™†åè‡ªåŠ¨åŒ–ä»»åŠ¡ -----------------------
local function judge_boot()
    local uptime_cmd = [[uptime |cut -d',' -f1 |awk '{gsub(/:/, "");print $(NF-1), $NF}']]
    local uptime_res, status, _, exitCode = hs.execute(uptime_cmd)
    local retVals = split(trim(uptime_res), " ")
    if not retVals then
        return false
    end
    if string.match(retVals[2], "secs") then
        return true
    elseif string.match(retVals[2], "day") then
        return false
    elseif string.match(retVals[2], "mins") and tonumber(retVals[1]) <= 2 then
        return true
    end
    return false
end

local function connect_bluetooth()
    if judge_boot() then
        connetBluetoothDevice()
    end
end

connect_bluetooth()

------------------------------------------------------------
local message = require("modules.status-message")
skmodal.statusMessage = message.new("SuperSKey Mode")
skmodal.entered = function()
    skmodal.statusMessage:show()
    skmodal.statusMessage:SMWatcher(skmodal.statusMessage)
end

skmodal.exited = function()
    skmodal.statusMessage:hide()
    skmodal.statusMessage:SMWatcher("off")
end

spoon.ModalMgr.supervisor:enter()
